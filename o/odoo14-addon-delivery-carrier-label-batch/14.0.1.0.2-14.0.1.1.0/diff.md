# Comparing `tmp/odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2-py3-none-any.whl.zip` & `tmp/odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,34 +1,34 @@
-Zip file size: 55894 bytes, number of entries: 32
--rw-r--r--  2.0 unx     3599 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/README.rst
--rw-r--r--  2.0 unx       42 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/__init__.py
--rw-r--r--  2.0 unx      873 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/__manifest__.py
--rw-r--r--  2.0 unx     1173 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/pdf_utils.py
--rw-r--r--  2.0 unx     3521 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/zpl_utils.py
--rw-r--r--  2.0 unx      488 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/data/ir.config_parameter.xml
--rw-r--r--  2.0 unx     9786 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/i18n/de.po
--rw-r--r--  2.0 unx     8610 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/i18n/delivery_carrier_label_batch.pot
--rw-r--r--  2.0 unx     9829 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/i18n/fr.po
--rw-r--r--  2.0 unx       34 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/models/__init__.py
--rw-r--r--  2.0 unx     3561 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/models/stock_batch_picking.py
--rw-r--r--  2.0 unx      249 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/readme/CONFIGURE.rst
--rw-r--r--  2.0 unx      117 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/readme/CONTRIBUTORS.rst
--rw-r--r--  2.0 unx       87 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/readme/CREDITS.rst
--rw-r--r--  2.0 unx      325 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/readme/DESCRIPTION.rst
--rw-r--r--  2.0 unx       50 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/readme/USAGE.rst
--rw-r--r--  2.0 unx      359 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/security/ir.model.access.csv
--rw-r--r--  2.0 unx     9455 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/static/description/icon.png
--rw-r--r--  2.0 unx    13561 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/static/description/index.html
--rw-r--r--  2.0 unx      947 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/tests/__init__.py
--rw-r--r--  2.0 unx    16947 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/tests/dummy.pdf
--rw-r--r--  2.0 unx     5616 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/tests/test_generate_labels.py
--rw-r--r--  2.0 unx     1116 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/views/stock_batch_picking.xml
--rw-r--r--  2.0 unx       58 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/wizard/__init__.py
--rw-r--r--  2.0 unx     1135 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/wizard/apply_carrier.py
--rw-r--r--  2.0 unx     1255 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/wizard/apply_carrier_view.xml
--rw-r--r--  2.0 unx    12105 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/wizard/generate_labels.py
--rw-r--r--  2.0 unx     1591 b- defN 22-Dec-06 08:31 odoo/addons/delivery_carrier_label_batch/wizard/generate_labels_view.xml
--rw-r--r--  2.0 unx     4307 b- defN 22-Dec-06 08:31 odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/METADATA
--rw-r--r--  2.0 unx       92 b- defN 22-Dec-06 08:31 odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/WHEEL
--rw-r--r--  2.0 unx        5 b- defN 22-Dec-06 08:31 odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     3774 b- defN 22-Dec-06 08:31 odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/RECORD
-32 files, 114667 bytes uncompressed, 49394 bytes compressed:  56.9%
+Zip file size: 56818 bytes, number of entries: 32
+-rw-r--r--  2.0 unx     3599 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/README.rst
+-rw-r--r--  2.0 unx       42 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/__init__.py
+-rw-r--r--  2.0 unx      873 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/__manifest__.py
+-rw-r--r--  2.0 unx     1173 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/pdf_utils.py
+-rw-r--r--  2.0 unx     3521 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/zpl_utils.py
+-rw-r--r--  2.0 unx      488 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/data/ir.config_parameter.xml
+-rw-r--r--  2.0 unx     9786 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/i18n/de.po
+-rw-r--r--  2.0 unx     8610 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/i18n/delivery_carrier_label_batch.pot
+-rw-r--r--  2.0 unx     9829 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/i18n/fr.po
+-rw-r--r--  2.0 unx       34 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/models/__init__.py
+-rw-r--r--  2.0 unx     4511 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/models/stock_batch_picking.py
+-rw-r--r--  2.0 unx      249 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/readme/CONFIGURE.rst
+-rw-r--r--  2.0 unx      117 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/readme/CONTRIBUTORS.rst
+-rw-r--r--  2.0 unx       87 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/readme/CREDITS.rst
+-rw-r--r--  2.0 unx      325 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/readme/DESCRIPTION.rst
+-rw-r--r--  2.0 unx       50 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/readme/USAGE.rst
+-rw-r--r--  2.0 unx      359 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/security/ir.model.access.csv
+-rw-r--r--  2.0 unx     9455 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/static/description/icon.png
+-rw-r--r--  2.0 unx    13561 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/static/description/index.html
+-rw-r--r--  2.0 unx      947 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/tests/__init__.py
+-rw-r--r--  2.0 unx    16947 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/tests/dummy.pdf
+-rw-r--r--  2.0 unx     9338 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/tests/test_generate_labels.py
+-rw-r--r--  2.0 unx     1116 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/views/stock_batch_picking.xml
+-rw-r--r--  2.0 unx       58 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/wizard/__init__.py
+-rw-r--r--  2.0 unx     1135 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/wizard/apply_carrier.py
+-rw-r--r--  2.0 unx     1255 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/wizard/apply_carrier_view.xml
+-rw-r--r--  2.0 unx    12203 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/wizard/generate_labels.py
+-rw-r--r--  2.0 unx     1591 b- defN 23-Apr-28 09:48 odoo/addons/delivery_carrier_label_batch/wizard/generate_labels_view.xml
+-rw-r--r--  2.0 unx     4307 b- defN 23-Apr-28 09:48 odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/METADATA
+-rw-r--r--  2.0 unx       92 b- defN 23-Apr-28 09:48 odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        5 b- defN 23-Apr-28 09:48 odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 unx     3774 b- defN 23-Apr-28 09:48 odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/RECORD
+32 files, 119437 bytes uncompressed, 50318 bytes compressed:  57.9%
```

## zipnote {}

```diff
@@ -78,20 +78,20 @@
 
 Filename: odoo/addons/delivery_carrier_label_batch/wizard/generate_labels.py
 Comment: 
 
 Filename: odoo/addons/delivery_carrier_label_batch/wizard/generate_labels_view.xml
 Comment: 
 
-Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/METADATA
+Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/METADATA
 Comment: 
 
-Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/WHEEL
+Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/WHEEL
 Comment: 
 
-Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/top_level.txt
+Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/top_level.txt
 Comment: 
 
-Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/RECORD
+Filename: odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## odoo/addons/delivery_carrier_label_batch/__manifest__.py

```diff
@@ -1,12 +1,12 @@
 # Copyright 2013-2019 Camptocamp SA
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl)
 {
     "name": "Carrier labels - Stock Batch Picking (link)",
-    "version": "14.0.1.0.2",
+    "version": "14.0.1.1.0",
     "author": "Camptocamp,Odoo Community Association (OCA)",
     "maintainer": "Camptocamp",
     "category": "Carrier",
     "complexity": "normal",
     "depends": ["base_delivery_carrier_label", "stock_picking_batch_extended"],
     "website": "https://github.com/OCA/delivery-carrier",
     "data": [
```

## odoo/addons/delivery_carrier_label_batch/models/stock_batch_picking.py

```diff
@@ -39,14 +39,15 @@
     @api.onchange("carrier_id")
     def carrier_id_change(self):
         """Inherit this method in your module"""
         if self.carrier_id:
             available_options = self.carrier_id.available_option_ids
             default_options = self._get_options_to_add()
             self.option_ids = [(6, 0, default_options.ids)]
+            self.carrier_code = self.carrier_id.code
             return {
                 "domain": {
                     "option_ids": [("id", "in", available_options.ids)],
                 }
             }
         return {}
 
@@ -77,26 +78,45 @@
             carrier = self.env["delivery.carrier"].browse(carrier_id)
             options = self._get_options_to_add(carrier)
             if options:
                 values.update(option_ids=[(6, 0, options.ids)])
         return values
 
     def write(self, values):
-        """Set the default options when the delivery method is changed.
-
-        So we are sure that the options are always in line with the
-        current delivery method.
-
-        """
+        # - Set the default options when the delivery method is changed (So we
+        #   are sure that the options are always in line with the current
+        #   delivery method)
+        # - Purge all tracking references if a new carrier is applied
         values = self._values_with_carrier_options(values)
-        return super(StockBatchPicking, self).write(values)
+        result = super().write(values)
+        # If a carrier is removed, tracking references are kept until next
+        # carrier change
+        if values.get("carrier_id", False):
+            self.purge_tracking_references()
+        return result
 
     @api.model
     def create(self, values):
         """Set the default options when the delivery method is set on creation
 
         So we are sure that the options are always in line with the
         current delivery method.
 
         """
         values = self._values_with_carrier_options(values)
-        return super(StockBatchPicking, self).create(values)
+        return super().create(values)
+
+    def purge_tracking_references(self):
+        """Purge tracking for each picking and destination package"""
+        for batch in self:
+            move_lines = batch.move_line_ids
+            packs = move_lines.result_package_id.filtered(lambda p: p.parcel_tracking)
+            if packs:
+                packs.write({"parcel_tracking": False})
+            pickings = self.env["stock.picking"].search(
+                [
+                    ("move_line_ids", "in", move_lines.ids),
+                    ("carrier_tracking_ref", "!=", False),
+                ]
+            )
+            if pickings:
+                pickings.write({"carrier_tracking_ref": False})
```

## odoo/addons/delivery_carrier_label_batch/tests/test_generate_labels.py

```diff
@@ -1,10 +1,11 @@
 # Copyright 2013-2019 Camptocamp SA
 # License AGPL-3.0 or later (http://www.gnu.org/licenses/agpl)
 import base64
+from unittest.mock import patch
 
 import odoo.tests.common as common
 from odoo import exceptions
 from odoo.modules import get_module_resource
 
 
 class TestGenerateLabels(common.SavepointCase):
@@ -16,14 +17,15 @@
         super(TestGenerateLabels, cls).setUpClass()
 
         Move = cls.env["stock.move"]
         Picking = cls.env["stock.picking"]
         ShippingLabel = cls.env["shipping.label"]
         BatchPicking = cls.env["stock.picking.batch"]
         cls.DeliveryCarrierLabelGenerate = cls.env["delivery.carrier.label.generate"]
+        cls.PickingBatchApplyCarrier = cls.env["picking.batch.apply.carrier"]
         cls.stock_location = cls.env.ref("stock.stock_location_stock")
         cls.customer_location = cls.env.ref("stock.stock_location_customers")
 
         cls.productA = cls.env["product.product"].create(
             {"name": "Product A", "type": "product"}
         )
         cls.productB = cls.env["product.product"].create(
@@ -32,101 +34,127 @@
         cls.env["stock.quant"]._update_available_quantity(
             cls.productA, cls.stock_location, 20.0
         )
         cls.env["stock.quant"]._update_available_quantity(
             cls.productB, cls.stock_location, 20.0
         )
 
-        picking_out_1 = Picking.create(
+        cls.carrier_product = cls.env["product.product"].create(
+            {
+                "name": "Test carrier product",
+                "type": "service",
+            }
+        )
+        cls.carrier = cls.env["delivery.carrier"].create(
+            {
+                "name": "Test carrier",
+                "delivery_type": "fixed",
+                "product_id": cls.carrier_product.id,
+            }
+        )
+        cls.new_carrier_product = cls.env["product.product"].create(
+            {
+                "name": "Test NEW carrier product",
+                "type": "service",
+            }
+        )
+        cls.new_carrier = cls.env["delivery.carrier"].create(
+            {
+                "name": "Test NEW carrier",
+                "delivery_type": "fixed",
+                "product_id": cls.new_carrier_product.id,
+            }
+        )
+        cls.picking_out_1 = Picking.create(
             {
                 "partner_id": cls.env.ref("base.res_partner_12").id,
                 "location_id": cls.stock_location.id,
                 "location_dest_id": cls.customer_location.id,
                 "picking_type_id": cls.env.ref("stock.picking_type_out").id,
+                "carrier_id": cls.carrier.id,
             }
         )
 
-        picking_out_2 = Picking.create(
+        cls.picking_out_2 = Picking.create(
             {
                 "partner_id": cls.env.ref("base.res_partner_12").id,
                 "location_id": cls.stock_location.id,
                 "location_dest_id": cls.customer_location.id,
                 "picking_type_id": cls.env.ref("stock.picking_type_out").id,
+                "carrier_id": cls.carrier.id,
             }
         )
 
         move1 = Move.create(
             {
                 "name": "/",
-                "picking_id": picking_out_1.id,
+                "picking_id": cls.picking_out_1.id,
                 "product_id": cls.productA.id,
                 "product_uom": cls.env.ref("uom.product_uom_unit").id,
                 "product_uom_qty": 2,
                 "location_id": cls.stock_location.id,
                 "location_dest_id": cls.customer_location.id,
             }
         )
 
         move2 = Move.create(
             {
                 "name": "/",
-                "picking_id": picking_out_2.id,
+                "picking_id": cls.picking_out_2.id,
                 "product_id": cls.productB.id,
                 "product_uom": cls.env.ref("uom.product_uom_unit").id,
                 "product_uom_qty": 1,
                 "location_id": cls.stock_location.id,
                 "location_dest_id": cls.customer_location.id,
             }
         )
 
         cls.batch = BatchPicking.create(
             {
                 "name": "demo_prep001",
-                "picking_ids": [(4, picking_out_1.id), (4, picking_out_2.id)],
+                "picking_ids": [(4, cls.picking_out_1.id), (4, cls.picking_out_2.id)],
                 "use_oca_batch_validation": True,
             }
         )
 
         cls.batch.action_confirm()
         cls.batch.action_assign()
 
         move1.move_line_ids[0].qty_done = 2
         move2.move_line_ids[0].qty_done = 2
 
-        picking_out_1.action_put_in_pack()
-        picking_out_2.action_put_in_pack()
+        cls.picking_out_1._set_a_default_package()
+        cls.picking_out_2._set_a_default_package()
 
-        label = ""
         dummy_pdf_path = get_module_resource(
             "delivery_carrier_label_batch", "tests", "dummy.pdf"
         )
         with open(dummy_pdf_path, "rb") as dummy_pdf:
             label = dummy_pdf.read()
-
-        ShippingLabel.create(
-            {
-                "name": "picking_out_1",
-                "res_id": picking_out_1.id,
-                "package_id": move1.move_line_ids[0].result_package_id.id,
-                "res_model": "stock.picking",
-                "datas": base64.b64encode(label),
-                "file_type": "pdf",
-            }
-        )
-
-        ShippingLabel.create(
-            {
-                "name": "picking_out_2",
-                "res_id": picking_out_2.id,
-                "package_id": move2.move_line_ids[0].result_package_id.id,
-                "res_model": "stock.picking",
-                "datas": base64.b64encode(label),
-                "file_type": "pdf",
-            }
-        )
+            cls.shipping_label_1 = ShippingLabel.create(
+                {
+                    "name": "picking_out_1",
+                    "res_id": cls.picking_out_1.id,
+                    "package_id": move1.move_line_ids[0].result_package_id.id,
+                    "res_model": "stock.picking",
+                    "datas": base64.b64encode(label),
+                    "file_type": "pdf",
+                }
+            )
+
+            cls.shipping_label_2 = ShippingLabel.create(
+                {
+                    "name": "picking_out_2",
+                    "res_id": cls.picking_out_2.id,
+                    "package_id": move2.move_line_ids[0].result_package_id.id,
+                    "res_model": "stock.picking",
+                    "datas": base64.b64encode(label),
+                    "file_type": "pdf",
+                }
+            )
 
     def test_action_generate_labels(self):
         """Check merging of pdf labels
 
         Test pdf generation without multiple threading
 
         """
@@ -153,7 +181,67 @@
         domain = [("picking_id", "in", self.batch.picking_ids.ids)]
         self.env["stock.package_level"].search(domain).unlink()
         wizard = self.DeliveryCarrierLabelGenerate.with_context(
             active_ids=self.batch.ids, active_model="stock.picking.batch"
         ).create({})
         with self.assertRaises(exceptions.UserError):
             wizard.action_generate_labels()
+
+    def test_action_regenerate_labels(self):
+        """Check re-generating labels"""
+        wizard = self.DeliveryCarrierLabelGenerate.with_context(
+            active_ids=self.batch.ids, active_model="stock.picking.batch"
+        ).create({"generate_new_labels": True})
+        with patch.object(
+            type(self.carrier), "fixed_send_shipping"
+        ) as fixed_send_shipping:
+            fixed_send_shipping.return_value = [
+                {
+                    "exact_price": 1.0,
+                    "tracking_number": "TEST00001",
+                }
+            ]
+            with patch.object(
+                type(self.batch), "purge_tracking_references"
+            ) as purge_tracking_references:
+                wizard.action_generate_labels()
+                purge_tracking_references.assert_called()
+
+            attachment = self.env["ir.attachment"].search(
+                [
+                    ("res_model", "=", "stock.picking.batch"),
+                    ("res_id", "=", self.batch.id),
+                ]
+            )
+
+            self.assertEqual(len(attachment), 1)
+            self.assertTrue(attachment.datas)
+            self.assertEqual(attachment.name, "demo_prep001.pdf")
+            self.assertEqual(attachment.mimetype, "application/pdf")
+            self.assertEqual(self.picking_out_1.carrier_tracking_ref, "TEST00001")
+            self.assertEqual(self.picking_out_2.carrier_tracking_ref, "TEST00001")
+
+    def test_batch_purge_tracking_reference(self):
+        """Unittest: check that tracking reference purge work as expected"""
+        self.batch.purge_tracking_references()
+        self.assertTrue(
+            all(
+                [
+                    not p.parcel_tracking
+                    for p in self.batch.move_line_ids.result_package_id
+                ]
+            )
+        )
+        pickings = [self.picking_out_1, self.picking_out_2]
+        self.assertTrue(all([not p.carrier_tracking_ref for p in pickings]))
+
+    def test_action_change_carrier_purge_tracking_reference(self):
+        """Functional: Check purge_tracking_reference is called as carrier is
+        changed from wizard"""
+        wizard = self.PickingBatchApplyCarrier.with_context(
+            active_ids=self.batch.ids
+        ).create({"carrier_id": self.new_carrier.id})
+        with patch.object(
+            type(self.batch), "purge_tracking_references"
+        ) as purge_tracking_references:
+            wizard.apply()
+            purge_tracking_references.assert_called()
```

## odoo/addons/delivery_carrier_label_batch/wizard/generate_labels.py

```diff
@@ -83,17 +83,17 @@
                 try:
                     picking.with_env(new_env).send_to_shipper()
                 except Exception as e:
                     # add information on picking and pack in the exception
                     picking_name = _("Picking: %s") % picking.name
                     pack_num = _("Pack: %s") % pack.name if pack else ""
                     # pylint: disable=translation-required
-                    raise exceptions.UserError(
-                        ("%s %s - %s") % (picking_name, pack_num, e)
-                    )
+                    msg = ("%s %s - %s") % (picking_name, pack_num, str(e))
+                    _logger.exception(msg)
+                    raise exceptions.UserError(msg)
 
     def _worker(self, data_queue, error_queue):
         """A worker to generate labels
         Takes data from queue data_queue
         And if the worker encounters errors, he will add them in
         error_queue queue
         """
@@ -247,14 +247,16 @@
                     ]
                 )
                 .mapped("res_id")
             )
             to_generate = to_generate.filtered(
                 lambda rec: rec.id not in already_generated_ids
             )
+        else:
+            to_generate.purge_tracking_references()
 
         for batch in to_generate:
             labels = self._get_all_files(batch)
             labels_by_f_type = self._group_labels_by_file_type(labels)
             for f_type, labels in labels_by_f_type.items():
                 if f_type == "zpl2" and not zpl2_batch_merge:
                     # We do not want to merge zpl2
```

## Comparing `odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/METADATA` & `odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/METADATA`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: odoo14-addon-delivery-carrier-label-batch
-Version: 14.0.1.0.2
+Version: 14.0.1.1.0
 Summary: Carrier labels - Stock Batch Picking (link)
 Home-page: https://github.com/OCA/delivery-carrier
 Author: Camptocamp,Odoo Community Association (OCA)
 Author-email: support@odoo-community.org
 License: AGPL-3
 Platform: UNKNOWN
 Classifier: Programming Language :: Python
```

## Comparing `odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/RECORD` & `odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/RECORD`

 * *Files 14% similar despite different names*

```diff
@@ -1,32 +1,32 @@
 odoo/addons/delivery_carrier_label_batch/README.rst,sha256=2gwhjC60fRzRk0tMiIUiZcGqc4cXca9tBt6edJtKacA,3599
 odoo/addons/delivery_carrier_label_batch/__init__.py,sha256=R3l5zcM1DHY7iqr3kt92069kmImpPafRbNSzv6p_hBE,42
-odoo/addons/delivery_carrier_label_batch/__manifest__.py,sha256=dD9QGpYdkNkwV6v4j-lvkKGQUAmxqOzhSMXaTkZ7jDs,873
+odoo/addons/delivery_carrier_label_batch/__manifest__.py,sha256=RBgW_YkGYAsxmFs3zDGmjQAdvxaZKd6zT4y05lidQCY,873
 odoo/addons/delivery_carrier_label_batch/pdf_utils.py,sha256=PywZyKDP7GMbCJKzL6FiYpXlx4aihpQ7XBDPgognZ4A,1173
 odoo/addons/delivery_carrier_label_batch/zpl_utils.py,sha256=dWzMULV53Mu1M3zzgnj2BfjiMq7WcEGTPj4dBGNzO9I,3521
 odoo/addons/delivery_carrier_label_batch/data/ir.config_parameter.xml,sha256=NK88NKz-k81LG-0a5qkYp1mEK_X8_Pe_hD-MFpJrovc,488
 odoo/addons/delivery_carrier_label_batch/i18n/de.po,sha256=OygZz5k74HguwwPWPwiU4DBn_1F7mnTNVuKhHGpn22E,9786
 odoo/addons/delivery_carrier_label_batch/i18n/delivery_carrier_label_batch.pot,sha256=5nO6XtYZtv_LwZwPiQOu_TdzByEvoNfWKdkXIkdXQDI,8610
 odoo/addons/delivery_carrier_label_batch/i18n/fr.po,sha256=kvwcyTvsR_XmN5Yvv9r5z8dS75qIIIrvZ5aVgI5Q1Io,9829
 odoo/addons/delivery_carrier_label_batch/models/__init__.py,sha256=bj70lenmI6ZFz8tI2oD2xHqf9HL6kZAihnwJYFevKao,34
-odoo/addons/delivery_carrier_label_batch/models/stock_batch_picking.py,sha256=MfkKZtQJI6wxNBeSBe22sJRc_YOziCPEeLHJVbWkczs,3561
+odoo/addons/delivery_carrier_label_batch/models/stock_batch_picking.py,sha256=x_iTRs07IW00X3ZKbOk4gotVlRirHxIPXCrBBlRTzbw,4511
 odoo/addons/delivery_carrier_label_batch/readme/CONFIGURE.rst,sha256=rCVwJovu9WmpEuy2q7V1EoxGzvLwiFHidUCnr8Qm-2c,249
 odoo/addons/delivery_carrier_label_batch/readme/CONTRIBUTORS.rst,sha256=TYrfgL4o4YhYfxkxmLPUR-HEHpBYuUAXYr22YOdkYwU,117
 odoo/addons/delivery_carrier_label_batch/readme/CREDITS.rst,sha256=OIENKihg6VoWNtyLh0WyclUw7kXltjIaeJZQEuq7TCI,87
 odoo/addons/delivery_carrier_label_batch/readme/DESCRIPTION.rst,sha256=S_ijqGOL2mQ3S5YyMXdZ8X6NqPHNGa-9MXyxJ2og8Sk,325
 odoo/addons/delivery_carrier_label_batch/readme/USAGE.rst,sha256=Dn0GO3HYXD_CM45cRtEw7KnmSTYW9kfqmRyr-REwg2M,50
 odoo/addons/delivery_carrier_label_batch/security/ir.model.access.csv,sha256=rpvD68gHud0q0jfyze7S2xd2w2gJjEccsjYxqW9VF_w,359
 odoo/addons/delivery_carrier_label_batch/static/description/icon.png,sha256=6xBPJauaFOF0KDHfHgQopSc28kKvxMaeoQFQWZtfZDo,9455
 odoo/addons/delivery_carrier_label_batch/static/description/index.html,sha256=jucCfbWk6FHbzJ2pL54A2T96Pg2Nth6bep3lhU5Rr18,13561
 odoo/addons/delivery_carrier_label_batch/tests/__init__.py,sha256=gpF6wdO-LrOdOJGemtDp87e8MbZSZnxu2e1MKM1WAEA,947
 odoo/addons/delivery_carrier_label_batch/tests/dummy.pdf,sha256=GH2jpBFVSnmcsLCGjWtWQnWuIqfRa1TzUdXk7NVGd9E,16947
-odoo/addons/delivery_carrier_label_batch/tests/test_generate_labels.py,sha256=sPU9DWYsjpiWUuvRDiJocbHtKN3qcsK-WTuqgtPGHM0,5616
+odoo/addons/delivery_carrier_label_batch/tests/test_generate_labels.py,sha256=rl903K_Z2fKYK_pGIsvkLGOHwumoeLf--f7jIweUGRY,9338
 odoo/addons/delivery_carrier_label_batch/views/stock_batch_picking.xml,sha256=XWrQ3djdGlsMP074qrAqUCv8ofW6MujuAl2Q9cmiHOU,1116
 odoo/addons/delivery_carrier_label_batch/wizard/__init__.py,sha256=ct5sQlJ4vSVumEyX0-6PsI_5BeZMNja3gFUKpGdFJwk,58
 odoo/addons/delivery_carrier_label_batch/wizard/apply_carrier.py,sha256=wIvLlAWt8byIk9kRrsWJsa2n9lzjIwrjxo1O26NkRh4,1135
 odoo/addons/delivery_carrier_label_batch/wizard/apply_carrier_view.xml,sha256=dgiTsF9bNH8-JvgWOX7OAg7yxwvbNeuQvzWzWJnaC88,1255
-odoo/addons/delivery_carrier_label_batch/wizard/generate_labels.py,sha256=rBwvydmOsxYyY5ywz1e7SvNk5hojhJm63r_p9L70kFk,12105
+odoo/addons/delivery_carrier_label_batch/wizard/generate_labels.py,sha256=HDh4Xw7cNd-mATFBHpTMBaG-iP0AUHyJ5WPFePKPpS0,12203
 odoo/addons/delivery_carrier_label_batch/wizard/generate_labels_view.xml,sha256=TH99LGPaZ_Q5x0QXVODv-yCVZ78P5nJr_H6o_TOwi0w,1591
-odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/METADATA,sha256=G4i2nOiKhwf6vQmQq6EO7dzQmisBS1eIvlSu-tUuoK8,4307
-odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/WHEEL,sha256=G16H4A3IeoQmnOrYV4ueZGKSjhipXx8zc8nu9FGlvMA,92
-odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
-odoo14_addon_delivery_carrier_label_batch-14.0.1.0.2.dist-info/RECORD,,
+odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/METADATA,sha256=4fpwZa5vuHSY6vSyB2XZBxJkny7CzhDH7AnDSaPm7nw,4307
+odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/WHEEL,sha256=2wepM1nk4DS4eFpYrW1TTqPcoGNfHhhO_i5m4cOimbo,92
+odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/top_level.txt,sha256=qBj40grFkGOfDZ2WDSw3y1RnDlgG0u8rP8pvGNdbz4w,5
+odoo14_addon_delivery_carrier_label_batch-14.0.1.1.0.dist-info/RECORD,,
```

